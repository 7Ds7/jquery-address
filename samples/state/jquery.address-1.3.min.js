/*
 * jQuery Address Plugin v1.3
 * http://www.asual.com/jquery/address/
 *
 * Copyright (c) 2009-2010 Rostislav Hristov
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * Date: 2010-09-15 18:46:35 +0300 (Wed, 15 Sep 2010)
 */
(function(c){c.address=function(){var w=function(a){c(c.address).trigger(c.extend(c.Event(a),function(){for(var b={},f=c.address.parameterNames(),g=0,q=f.length;g<q;g++)b[f[g]]=c.address.parameter(f[g]);return{value:c.address.value(),path:c.address.path(),pathNames:c.address.pathNames(),parameterNames:f,parameters:b,queryString:c.address.queryString()}}.call(c.address)))},x=function(a,b,f){c(c.address).bind(a,b,f);return c.address},F=function(){return e.href.replace(new RegExp("^.*"+d.state+"(/$)?"),
"")},P=function(){var a=e.href.indexOf("#");return a!=-1?y(e.href.substr(a+1),l):""},z=function(){return t.pushState&&typeof d.state!==r?F():P()},qa=function(){return"javascript"},Z=function(a,b){if(d.strict)a=b?a.substr(0,1)!="/"?"/"+a:a:a==""?"/":a;return a},y=function(a,b){if(d.crawlable&&b)return(a!=""?"!":"")+a;return a.replace(/^\!/,"")},A=function(a,b){return parseInt(a.css(b),10)},$=function(a){for(var b,f,g=0,q=a.childNodes.length;g<q;g++){if(a.childNodes[g].src)b=String(a.childNodes[g].src);
if(f=$(a.childNodes[g]))b=f}return b},K=function(){if(!Q){var a=z(),b=h!=a;if(B&&o<523){if(G!=t.length){G=t.length;if(typeof E[G-1]!=r)h=E[G-1];H(l)}}else if(b)if(C&&o<7)e.reload();else{C&&o<8&&d.history&&u(T,50);h=a;H(l)}}},H=function(a){w(aa);w(a?ba:ca);u(da,10)},da=function(){if(d.tracker!=="null"&&d.tracker!==null){var a=c.isFunction(d.tracker)?d.tracker:j[d.tracker],b=(e.pathname+(c.address?c.address.value():"")).replace(/\/\//,"/").replace(/^\/$/,"");if(c.isFunction(a))a(b);else if(c.isFunction(j.urchinTracker))j.urchinTracker(b);
else if(typeof j.pageTracker!=r&&c.isFunction(j.pageTracker._trackPageview))j.pageTracker._trackPageview(b);else typeof j._gaq!=r&&c.isFunction(j._gaq.push)&&j._gaq.push(["_trackPageview",b])}},T=function(){var a=qa()+":"+l+";document.open();document.writeln('<html><head><title>"+m.title+"</title><script>var "+p+' = "'+z()+(m.domain!=e.host?'";document.domain="'+m.domain:"")+"\";<\/script></head></html>');document.close();";if(o<7)n.src=a;else n.contentWindow.location.replace(a)},fa=function(){if(L&&
ea!=-1){var a,b=L.substr(ea+1).split("&");for(s=0;s<b.length;s++){a=b[s].split("=");if(/^(autoUpdate|crawlable|history|strict|wrap)$/.test(a[0]))d[a[0]]=isNaN(a[1])?/^(true|yes)$/i.test(a[1]):parseInt(a[1],10)!==0;if(/^(state|tracker)$/.test(a[0]))d[a[0]]=a[1]}L=null}h=z()},ha=function(){if(!ga){ga=k;fa();var a=c("body").ajaxComplete(function(){ra.call(this);sa.call(this)}).trigger("ajaxComplete");if(d.wrap){c("body > *").wrapAll('<div style="padding:'+(A(a,"marginTop")+A(a,"paddingTop"))+"px "+(A(a,
"marginRight")+A(a,"paddingRight"))+"px "+(A(a,"marginBottom")+A(a,"paddingBottom"))+"px "+(A(a,"marginLeft")+A(a,"paddingLeft"))+'px;" />').parent().wrap('<div id="'+p+'" style="height:100%; overflow:auto;'+(B?window.statusbar.visible&&!/chrome/i.test(U)?"":" resize:both;":"")+'" />');c("html, body").css({height:"100%",margin:0,padding:0,overflow:"hidden"});B&&c('<style type="text/css" />').appendTo("head").text("#"+p+"::-webkit-resizer { background-color: #fff; }")}if(C&&o<8){a=m.getElementsByTagName("frameset")[0];
n=m.createElement((a?"":"i")+"frame");if(a){a.insertAdjacentElement("beforeEnd",n);a[a.cols?"cols":"rows"]+=",0";n.noResize=k;n.frameBorder=n.frameSpacing=0}else{n.style.display="none";n.style.width=n.style.height=0;n.tabIndex=-1;m.body.insertAdjacentElement("afterBegin",n)}u(function(){c(n).bind("load",function(){var b=n.contentWindow;h=typeof b[p]!=r?b[p]:"";if(h!=z()){H(l);e.hash=y(h,k)}});typeof n.contentWindow[p]==r&&T()},50)}else if(B){if(o<418){c(m.body).append('<form id="'+p+'" style="position:absolute;top:-9999px;" method="get"></form>');
V=m.getElementById(p)}if(typeof e[p]==r)e[p]={};if(typeof e[p][e.pathname]!=r)E=e[p][e.pathname].split(",")}u(function(){w("init");H(l)},1);if(C&&o>7||!C&&"on"+M in j)if(j.addEventListener)j.addEventListener(M,K,false);else j.attachEvent&&j.attachEvent("on"+M,K);else ta(K,50)}},ra=function(){var a,b=c("a"),f=b.size(),g=-1;u(function(){if(++g!=f){a=c(b.get(g));a.is("[rel*=address:]")&&a.address();u(arguments.callee,1)}},1)},ua=function(){h=z();H(l)},va=function(){if(j.removeEventListener)j.removeEventListener(M,
K,false);else j.detachEvent&&j.detachEvent("on"+M,K)},sa=function(){var a=e.pathname.replace(/\/$/,"");c("body").html().indexOf("_escaped_fragment_")!=-1&&c("a[href]:not([href^=http]), , a[href*="+document.domain+"]",this).each(function(){var b=c(this).attr("href").replace(/^http:/,"").replace(new RegExp(a+"/?$"),"");if(b==""||b.indexOf("_escaped_fragment_")!=-1)c(this).attr("href","#"+this.decode(b.replace(/\/(.*)\?_escaped_fragment_=(.*)$/,"!$2")))})},I=function(a){return encodeURIComponent(a).replace(/%20/g,
"+")},ia=function(a){return a.split("#")[0].split("?")[0]},ja=function(a){a=ia(a);var b=a.replace(/\/{2,9}/g,"/").split("/");if(a.substr(0,1)=="/"||a.length===0)b.splice(0,1);a.substr(a.length-1,1)=="/"&&b.splice(b.length-1,1);return b},R=function(a){a=a.split("?");return a.slice(1,a.length).join("?").split("#")[0]},ka=function(a,b){if(b=R(b)){params=b.split("&");b=[];for(s=0;s<params.length;s++){var f=params[s].split("=");f[0]==a&&b.push(f.slice(1).join("="))}if(b.length!==0)return b.length!=1?b:
b[0]}},la=function(a){var b=R(a);a=[];if(b&&b.indexOf("=")!=-1){b=b.split("&");for(var f=0;f<b.length;f++){var g=b[f].split("=")[0];c.inArray(g,a)==-1&&a.push(g)}}return a},ma=function(a){a=a.split("#");return a.slice(1,a.length).join("#")},p="jQueryAddress",r="undefined",M="hashchange",aa="change",ba="internalChange",ca="externalChange",k=true,l=false,d={autoUpdate:k,crawlable:l,history:k,strict:k,wrap:l},D=c.browser,o=parseFloat(c.browser.version),na=D.mozilla,C=D.msie,oa=D.opera,B=D.webkit,W=l,
j=function(){try{return top.document!==undefined?top:window}catch(a){return window}}(),m=j.document,t=j.history,e=j.location,ta=setInterval,u=setTimeout,U=navigator.userAgent,n,V,L=$(document),ea=L?L.indexOf("?"):-1,X=m.title,G=t.length,Q=l,ga=l,Y=k,pa=k,S=l,E=[],h=z();if(C){o=parseFloat(U.substr(U.indexOf("MSIE")+4));if(m.documentMode&&m.documentMode!=o)o=m.documentMode!=8?7:8;c(document).bind("propertychange",function(){if(m.title!=X&&m.title.indexOf("#"+z())!=-1)m.title=X})}if(W=na&&o>=1||C&&o>=
6||oa&&o>=9.5||B&&o>=312){for(var s=1;s<G;s++)E.push("");E.push(h);if(oa)history.navigationMode="compatible";if(document.readyState=="complete")var wa=setInterval(function(){if(c.address){ha();clearInterval(wa)}},50);else{fa();c(ha)}D=F();!t.pushState&&typeof d.state!==r&&D!="/"&&D.replace(/^\/#/,"")!=P()&&e.replace(d.state+"/#"+D);c(window).bind("popstate",ua).bind("unload",va)}else!W&&P()!=""||B&&o<418&&P()!=""&&e.search!=""?e.replace(e.href.substr(0,e.href.indexOf("#"))):da();return{bind:function(a,
b,f){return x(a,b,f)},init:function(a){return x("init",a)},change:function(a){return x(aa,a)},internalChange:function(a){return x(ba,a)},externalChange:function(a){return x(ca,a)},baseURL:function(){var a=e.href;if(a.indexOf("#")!=-1)a=a.substr(0,a.indexOf("#"));if(/\/$/.test(a))a=a.substr(0,a.length-1);return a},autoUpdate:function(a){if(a!==undefined){d.autoUpdate=a;return this}return d.autoUpdate},crawlable:function(a){if(a!==undefined){d.crawlable=a;return this}return d.crawlable},history:function(a){if(a!==
undefined){d.history=a;return this}return d.history},state:function(a){if(a!==undefined){d.state=a;return this}return d.state},strict:function(a){if(a!==undefined){d.strict=a;return this}return d.strict},tracker:function(a){if(a!==undefined){d.tracker=a;return this}return d.tracker},wrap:function(a){if(a!==undefined){d.wrap=a;return this}return d.wrap},update:function(){S=k;this.value(h);S=l;return this},encode:function(a){var b=ja(a),f=la(a),g=R(a),q=ma(a),N=a.substr(0,1),J=a.substr(a.length-1),
i="";c.each(b,function(v,O){i+="/"+I(O)});if(g!==""){i+="?";if(f.length===0)i+=g;else{c.each(f,function(v,O){v=ka(O,a);if(typeof v!=="string")c.each(v,function(ya,xa){i+=I(O)+"="+I(xa)+"&"});else i+=I(O)+"="+I(v)+"&"});i=i.substr(0,i.length-1)}}if(q!=="")i+="#"+I(q);if(N!="/"&&i.substr(0,1)=="/")i=i.substr(1);if(/#|&|\?/.test(J))i+=J;return i},decode:function(a){return decodeURIComponent(a.replace(/\+/g,"%20"))},title:function(a){if(a!==undefined){u(function(){X=m.title=a;if(pa&&n&&n.contentWindow&&
n.contentWindow.document){n.contentWindow.document.title=a;pa=l}if(!Y&&na)e.replace(e.href.indexOf("#")!=-1?e.href:e.href+"#");Y=l},50);return this}return m.title},value:function(a){if(a!==undefined){a=Z(this.encode(a),k);if(a=="/")a="";if(h==a&&!S)return;Y=k;h=a;if(d.autoUpdate||S){H(k);if(t.pushState&&typeof d.state!==r)t[d.history?"pushState":"replaceState"]({},"",d.state+(h==""?"/":h));else{Q=k;E[t.length]=h;if(B)if(d.history){e[p][e.pathname]=E.toString();G=t.length+1;if(o<418){if(e.search==
""){V.action="#"+y(h,k);V.submit()}}else if(o<523||h==""){a=m.createEvent("MouseEvents");a.initEvent("click",k,k);var b=m.createElement("a");b.href="#"+y(h,k);b.dispatchEvent(a)}else e.hash="#"+y(h,k)}else e.replace("#"+y(h,k));else if(h!=z())if(d.history)e.hash="#"+y(h,k);else e.replace("#"+y(h,k));C&&o<8&&d.history&&u(T,50);if(B)u(function(){Q=l},1);else Q=l}}return this}if(!W)return null;return Z(this.decode(h),l)},path:function(a){if(a!==undefined){var b=this.queryString(),f=this.hash();this.value(a+
(b?"?"+b:"")+(f?"#"+f:""));return this}return ia(this.value())},pathNames:function(){return ja(this.value())},queryString:function(a){if(a!==undefined){var b=this.hash();this.value(this.path()+(a?"?"+a:"")+(b?"#"+b:""));return this}return R(this.value())},parameter:function(a,b,f){var g,q;if(b!==undefined){var N=this.parameterNames();q=[];for(g=0;g<N.length;g++){var J=N[g],i=this.parameter(J);if(typeof i=="string")i=[i];if(J==a)i=b===null||b===""?[]:f?i.concat([b]):[b];for(var v=0;v<i.length;v++)q.push(J+
"="+i[v])}c.inArray(a,N)==-1&&b!==null&&b!==""&&q.push(a+"="+b);this.queryString(q.join("&"));return this}return ka(a,this.value())},parameterNames:function(){return la(this.value())},hash:function(a){if(a!==undefined){this.value(this.value().split("#")[0]+(a?"#"+a:""));return this}return ma(this.value())}}}();c.fn.address=function(w){if(!c(this).attr("address")){var x=function(){if(c(this).is("a")){var F=w?w.call(this):/address:/.test(c(this).attr("rel"))?c(this).attr("rel").split("address:")[1].split(" ")[0]:
typeof c.address.state()!=="undefined"?c(this).attr("href").replace(new RegExp("^(.*"+c.address.state()+"|\\.)"),""):c(this).attr("href").replace(/^(#\!?|\.)/,"");c.address.value(F);return false}};c(this).click(x).live("click",x).submit(function(){if(c(this).is("form")){var F=w?w.call(this):c(this).attr("action")+"?"+c.address.decode(c(this).serialize());c.address.value(F);return false}}).attr("address",true)}return this}})(jQuery);
